{"ast":null,"code":"import Axios from \"axios\";\nimport AccountService from \"./AccountService\";\nimport { LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY } from '../Utility/GlobalConstants';\nimport createAuthRefreshInterceptor from 'axios-auth-refresh';\nimport Utility from \"../Utility/Utility\";\n\nclass ApiUtil {\n  createJwtToken(token) {\n    return 'Bearer ' + token;\n  }\n\n  setupInterceptors(token, authenticationChangeHandler) {\n    console.log(\"setting up interceptors\");\n    const requestInterceptor = this.setupRequestInterceptor(token);\n\n    const refreshAuthLogic = failedRequest => {\n      Axios.interceptors.request.eject(requestInterceptor);\n      return AccountService.refreshToken(token).then(response => {\n        console.log(\"Got a response\");\n        if (localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY)) localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token);\n        sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token);\n        this.setupInterceptors(response.data.token, authenticationChangeHandler);\n        authenticationChangeHandler();\n        return Promise.resolve();\n      }).catch(error => {\n        Utility.logOut(authenticationChangeHandler);\n        return Promise.reject(error);\n      });\n    };\n\n    createAuthRefreshInterceptor(Axios, refreshAuthLogic);\n  }\n\n  setupRequestInterceptor(token) {\n    let header = this.createJwtToken(token);\n    const interceptor = Axios.interceptors.request.use(config => {\n      config.headers.authorization = header;\n      return config;\n    });\n    console.log(\"interceptor returned is \" + interceptor);\n    return interceptor;\n  }\n\n  setupResponseInterceptor(token, handler, requestInterceptor) {\n    const interceptor = Axios.interceptors.response.use(response => response, error => {\n      if (error.response.status !== 401) return Promise.reject(error);\n      Axios.interceptors.response.eject(interceptor);\n      Axios.interceptors.request.eject(requestInterceptor);\n      AccountService.refreshToken(token).then(response => {\n        this.setupInterceptors(response.data.token);\n        if (localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY)) localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token);\n        sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token);\n      }).catch(error => {\n        console.log(\"error again\");\n        sessionStorage.clear();\n        localStorage.clear();\n        console.log(requestInterceptor);\n        handler();\n        return Promise.reject(error);\n      });\n    });\n    return interceptor;\n  }\n\n}\n\nexport default new ApiUtil();","map":{"version":3,"sources":["D:/Projects/Birthday Calendar/birthday-calendar-react/src/ApiServices/ApiUtil.js"],"names":["Axios","AccountService","LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY","SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY","createAuthRefreshInterceptor","Utility","ApiUtil","createJwtToken","token","setupInterceptors","authenticationChangeHandler","console","log","requestInterceptor","setupRequestInterceptor","refreshAuthLogic","failedRequest","interceptors","request","eject","refreshToken","then","response","localStorage","getItem","setItem","data","sessionStorage","Promise","resolve","catch","error","logOut","reject","header","interceptor","use","config","headers","authorization","setupResponseInterceptor","handler","status","clear"],"mappings":"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","sourcesContent":["import Axios from \"axios\"\r\nimport AccountService from \"./AccountService\"\r\nimport { LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY } from '../Utility/GlobalConstants'\r\nimport createAuthRefreshInterceptor from 'axios-auth-refresh';\r\nimport Utility from \"../Utility/Utility\";\r\n\r\nclass ApiUtil {\r\n    createJwtToken(token) {\r\n        return 'Bearer ' + token\r\n    }\r\n\r\n    setupInterceptors(token, authenticationChangeHandler) {\r\n        console.log(\"setting up interceptors\")\r\n        const requestInterceptor = this.setupRequestInterceptor(token)\r\n        const refreshAuthLogic = failedRequest => \r\n        {\r\n            Axios.interceptors.request.eject(requestInterceptor)\r\n            return AccountService.refreshToken(token)\r\n            .then(response => {\r\n                console.log(\"Got a response\")\r\n                if (localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY))  localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                this.setupInterceptors(response.data.token, authenticationChangeHandler)\r\n                authenticationChangeHandler();\r\n                return Promise.resolve();\r\n            })\r\n            .catch(error => {\r\n                Utility.logOut(authenticationChangeHandler)\r\n                return Promise.reject(error)\r\n            })\r\n        }            \r\n        createAuthRefreshInterceptor(Axios, refreshAuthLogic);\r\n    } \r\n\r\n    setupRequestInterceptor(token) {\r\n        let header = this.createJwtToken(token)\r\n        const interceptor = Axios.interceptors.request.use(\r\n            (config) => {\r\n                config.headers.authorization = header\r\n                return config\r\n            }\r\n        )\r\n        console.log(\"interceptor returned is \" + interceptor)\r\n        return interceptor\r\n    }\r\n\r\n    setupResponseInterceptor(token, handler, requestInterceptor) {\r\n        const interceptor = Axios.interceptors.response.use(\r\n            response => response,\r\n            error =>\r\n            {\r\n                if (error.response.status !== 401) return Promise.reject(error);\r\n                Axios.interceptors.response.eject(interceptor)\r\n                Axios.interceptors.request.eject(requestInterceptor)\r\n                AccountService.refreshToken(token)\r\n                .then(\r\n                    response => {\r\n                        this.setupInterceptors(response.data.token)\r\n                        if (localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY))  localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                        sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                    }\r\n                )\r\n                .catch(\r\n                    error => {\r\n                        console.log(\"error again\")\r\n                        sessionStorage.clear()\r\n                        localStorage.clear()\r\n                        console.log(requestInterceptor)\r\n                        handler()                        \r\n                        return Promise.reject(error);\r\n                    }\r\n                )\r\n            }\r\n        )\r\n        return interceptor\r\n    }\r\n}\r\n\r\nexport default new ApiUtil()"]},"metadata":{},"sourceType":"module"}