{"ast":null,"code":"import _classCallCheck from\"D:\\\\Projects\\\\Birthday Calendar\\\\birthday-calendar-react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"D:\\\\Projects\\\\Birthday Calendar\\\\birthday-calendar-react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import Axios from\"axios\";import AccountService from\"./AccountService\";import{LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY,SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY}from'../Utility/GlobalConstants';import createAuthRefreshInterceptor from'axios-auth-refresh';import Utility from\"../Utility/Utility\";var ApiUtil=/*#__PURE__*/function(){function ApiUtil(){_classCallCheck(this,ApiUtil);}_createClass(ApiUtil,[{key:\"createJwtToken\",value:function createJwtToken(token){return'Bearer '+token;}},{key:\"setupInterceptors\",value:function setupInterceptors(token,authenticationChangeHandler){var _this=this;console.log(\"setting up interceptors\");var requestInterceptor=this.setupRequestInterceptor(token);var refreshAuthLogic=function refreshAuthLogic(failedRequest){Axios.interceptors.request.eject(requestInterceptor);return AccountService.refreshToken(token).then(function(response){console.log(\"Got a response\");if(localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY))localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY,response.data.token);sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY,response.data.token);_this.setupInterceptors(response.data.token,authenticationChangeHandler);authenticationChangeHandler();return Promise.resolve();}).catch(function(error){Utility.logOut(authenticationChangeHandler);return Promise.reject(error);});};createAuthRefreshInterceptor(Axios,refreshAuthLogic);}},{key:\"setupRequestInterceptor\",value:function setupRequestInterceptor(token){var header=this.createJwtToken(token);var interceptor=Axios.interceptors.request.use(function(config){config.headers.authorization=header;return config;});console.log(\"interceptor returned is \"+interceptor);return interceptor;}},{key:\"setupResponseInterceptor\",value:function setupResponseInterceptor(token,handler,requestInterceptor){var _this2=this;var interceptor=Axios.interceptors.response.use(function(response){return response;},function(error){if(error.response.status!==401)return Promise.reject(error);Axios.interceptors.response.eject(interceptor);Axios.interceptors.request.eject(requestInterceptor);AccountService.refreshToken(token).then(function(response){_this2.setupInterceptors(response.data.token);if(localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY))localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY,response.data.token);sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY,response.data.token);}).catch(function(error){console.log(\"error again\");sessionStorage.clear();localStorage.clear();console.log(requestInterceptor);handler();return Promise.reject(error);});});return interceptor;}}]);return ApiUtil;}();export default new ApiUtil();","map":{"version":3,"sources":["D:/Projects/Birthday Calendar/birthday-calendar-react/src/ApiServices/ApiUtil.js"],"names":["Axios","AccountService","LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY","SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY","createAuthRefreshInterceptor","Utility","ApiUtil","token","authenticationChangeHandler","console","log","requestInterceptor","setupRequestInterceptor","refreshAuthLogic","failedRequest","interceptors","request","eject","refreshToken","then","response","localStorage","getItem","setItem","data","sessionStorage","setupInterceptors","Promise","resolve","catch","error","logOut","reject","header","createJwtToken","interceptor","use","config","headers","authorization","handler","status","clear"],"mappings":"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","sourcesContent":["import Axios from \"axios\"\r\nimport AccountService from \"./AccountService\"\r\nimport { LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY } from '../Utility/GlobalConstants'\r\nimport createAuthRefreshInterceptor from 'axios-auth-refresh';\r\nimport Utility from \"../Utility/Utility\";\r\n\r\nclass ApiUtil {\r\n    createJwtToken(token) {\r\n        return 'Bearer ' + token\r\n    }\r\n\r\n    setupInterceptors(token, authenticationChangeHandler) {\r\n        console.log(\"setting up interceptors\")\r\n        const requestInterceptor = this.setupRequestInterceptor(token)\r\n        const refreshAuthLogic = failedRequest => \r\n        {\r\n            Axios.interceptors.request.eject(requestInterceptor)\r\n            return AccountService.refreshToken(token)\r\n            .then(response => {\r\n                console.log(\"Got a response\")\r\n                if (localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY))  localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                this.setupInterceptors(response.data.token, authenticationChangeHandler)\r\n                authenticationChangeHandler();\r\n                return Promise.resolve();\r\n            })\r\n            .catch(error => {\r\n                Utility.logOut(authenticationChangeHandler)\r\n                return Promise.reject(error)\r\n            })\r\n        }            \r\n        createAuthRefreshInterceptor(Axios, refreshAuthLogic);\r\n    } \r\n\r\n    setupRequestInterceptor(token) {\r\n        let header = this.createJwtToken(token)\r\n        const interceptor = Axios.interceptors.request.use(\r\n            (config) => {\r\n                config.headers.authorization = header\r\n                return config\r\n            }\r\n        )\r\n        console.log(\"interceptor returned is \" + interceptor)\r\n        return interceptor\r\n    }\r\n\r\n    setupResponseInterceptor(token, handler, requestInterceptor) {\r\n        const interceptor = Axios.interceptors.response.use(\r\n            response => response,\r\n            error =>\r\n            {\r\n                if (error.response.status !== 401) return Promise.reject(error);\r\n                Axios.interceptors.response.eject(interceptor)\r\n                Axios.interceptors.request.eject(requestInterceptor)\r\n                AccountService.refreshToken(token)\r\n                .then(\r\n                    response => {\r\n                        this.setupInterceptors(response.data.token)\r\n                        if (localStorage.getItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY))  localStorage.setItem(LOCAL_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                        sessionStorage.setItem(SESSION_STORAGE_AUTHENTICATION_TOKEN_KEY, response.data.token)\r\n                    }\r\n                )\r\n                .catch(\r\n                    error => {\r\n                        console.log(\"error again\")\r\n                        sessionStorage.clear()\r\n                        localStorage.clear()\r\n                        console.log(requestInterceptor)\r\n                        handler()                        \r\n                        return Promise.reject(error);\r\n                    }\r\n                )\r\n            }\r\n        )\r\n        return interceptor\r\n    }\r\n}\r\n\r\nexport default new ApiUtil()"]},"metadata":{},"sourceType":"module"}